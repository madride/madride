#!/usr/bin/env ruby

#
# Require libraries
#

require 'optparse'
require 'madride'
require 'rack'

#
# Options container. Filled in with default values.
#

options = { :host => '0.0.0.0', :port => 3000, :data => {}, :paths => [] }

#
# Parse options
#

OptionParser.new("", 24, '  ') do |opts|
  opts.banner = "Usage: madride [options] [PATH ...]"

  opts.separator ""
  opts.separator "Options:"

  opts.on("-a", "--addr HOST", "listen on HOST (default: 0.0.0.0)") do |addr|
    options[:host] = addr
  end

  opts.on("-p", "--port PORT", "use PORT (default: 3000)") do |port|
    options[:port] = port
  end

  opts.on("-w", "--with PLUGIN", "include PLUGIN") do |plugin|
    begin
      require "madride-with-#{plugin}"
    rescue LoadError
      puts "Plugin #{plugin} not found"
    end
  end

  opts.on("-d", "--data FILE", "read data from yaml FILE") do |file|
    options[:data].merge! YAML.load_file file
  end

  #
  # No arguments given - show usage help
  #

  if ARGV.empty?
    puts opts.help
    exit 1
  end

  #
  # Parse options
  #

  begin
    opts.order(ARGV){ |path| options[:paths] << path }
  rescue OptionParser::ParseError => e
    opts.warn e.message
    exit 1
  end

  #
  # We need at least one path
  #

  if options[:paths].empty?
    opts.warn "No paths given. See `madride --help` for usage info."
    exit 1
  end
end

#
# Create new madride environment
#

environment = Madride::Environment.new Dir.pwd

#
# Fill in paths
#

options[:paths].each{ |path| environment.append_path path }

#
# Start server
#

Rack::Server.start(
  :Host   => options[:host],
  :Port   => options[:port],
  :server => 'webrick',
  :app    => environment
)
